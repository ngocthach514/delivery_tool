<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh sách đơn hàng</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        font-size: 13px;
        margin: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 100%;
        margin: 0 auto;
        padding-bottom: 80px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      th,
      td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
        height: 60px;
        vertical-align: middle;
        font-size: 13px;
      }
      th {
        background-color: #4caf50;
        color: white;
      }
      tr:hover {
        filter: brightness(0.95);
      }
      td.priority-urgent {
        background-color: #ff9999;
        color: #660000;
      }
      td.priority-high {
        background-color: #ffe5e5;
        color: #804040;
      }
      td.priority-normal {
        background-color: #ffffff;
        color: #000000;
      }
      .pagination {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #fff;
        padding: 10px 20px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        z-index: 1000;
      }
      .pagination button {
        padding: 8px 12px;
        margin: 0 5px;
        border: none;
        background-color: #4caf50;
        color: white;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
      }
      .pagination button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      /* Kiểu cho container danh sách thông báo */
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 300px;
        z-index: 2000;
        display: none;
      }
      .notification-blink {
        background-color: #ff0000;
        color: white;
        font-weight: bold;
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        animation: blink 1s infinite;
        list-style: none;
      }
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <ul class="nav nav-tabs mb-3" id="orderTabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-day="today">
            Hôm nay
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-day="yesterday">
            Hôm qua
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-day="older">
            Trước nữa
          </button>
        </li>
      </ul>
      <h1>Danh sách đơn hàng</h1>

      <div class="d-flex justify-content-center mb-3">
        <input
          type="text"
          id="searchInput"
          class="form-control w-50"
          placeholder="Tìm theo mã đơn hàng..."
          oninput="debouncedSearch()"
        />
      </div>

      <div class="d-flex justify-content-center mb-4 gap-3">
        <select id="districtSelect" class="form-select w-25" multiple></select>
        <select id="wardSelect" class="form-select w-25" multiple></select>
      </div>

      <div id="notification-container" class="notification-container">
        <ul id="notification-list"></ul>
      </div>
      <div id="loading" class="text-center mb-2">Đang tải dữ liệu...</div>
      <div
        id="error"
        class="text-danger text-center mb-2"
        style="display: none"
      ></div>

      <div id="orders-wrapper"></div>
      <div class="pagination" id="pagination"></div>
    </div>

    <script>
      const apiUrl = "/grouped-orders";
      let currentDay = "today";
      let currentPage = 1;
      let totalPages = 1;
      let allOrders = [];
      let locationLoaded = false;
      let districtWardMap = {};

      fetchOrders(currentDay, 1);

      const socket = io();
      socket.on("connect", () => console.log("Connected"));
      socket.on("statusUpdated", (data) => {
        $("#notification-list").append(
          `<li class="text-success">${data.message} (${data.updatedCount} đơn hàng)</li>`
        );
        $("#notification-container").fadeIn();
        setTimeout(() => {
          $("#notification-list .text-success").remove();
          if ($("#notification-list").children().length === 0) {
            $("#notification-container").fadeOut();
          }
        }, 3000);
        fetchOrders(currentDay, currentPage);
      });

      document.querySelectorAll("#orderTabs .nav-link").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll("#orderTabs .nav-link")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentDay = tab.getAttribute("data-day");
          fetchOrders(currentDay, 1);
        });
      });

      async function fetchOrders(day = "today", page = 1) {
        try {
          $("#loading").show();
          $("#error").hide();

          const res = await fetch(`${apiUrl}?day=${day}&page=${page}`);
          if (!res.ok) throw new Error("Không thể lấy dữ liệu từ API.");
          const data = await res.json();

          totalPages = data.totalPages || 1;
          currentPage = data.currentPage || 1;
          allOrders = data.orders;
          renderOrders(data.orders);
          renderPagination();

          if (!locationLoaded) {
            const locationRes = await fetch("/locations");
            if (!locationRes.ok)
              throw new Error("Không lấy được danh sách quận/phường.");
            const locationData = await locationRes.json();
            initSelectFilters(locationData);
            locationLoaded = true;
          }
        } catch (err) {
          $("#error")
            .text("Lỗi: " + err.message)
            .show();
        } finally {
          $("#loading").hide();
        }
      }

      function initSelectFilters(data) {
        const districtSelect = $("#districtSelect");
        const wardSelect = $("#wardSelect");

        districtWardMap = {};
        data.mapping?.forEach((entry) => {
          const { district, ward } = entry;
          if (district && ward) {
            if (!districtWardMap[district]) districtWardMap[district] = [];
            if (!districtWardMap[district].includes(ward)) {
              districtWardMap[district].push(ward);
            }
          }
        });

        const uniqueDistricts = [
          ...new Set(data.mapping.map((d) => d.district)),
        ];
        districtSelect.html(
          uniqueDistricts.map((d) => `<option value="${d}">${d}</option>`)
        );

        const allWards = [...new Set(data.mapping.map((d) => d.ward))];
        wardSelect.html(
          allWards.map((w) => `<option value="${w}">${w}</option>`)
        );

        districtSelect.select2({
          placeholder: "Chọn Quận/Huyện",
          multiple: true,
        });
        wardSelect.select2({ placeholder: "Chọn Phường/Xã", multiple: true });

        districtSelect.on("change", () => {
          const selectedDistricts = districtSelect.val();

          if (selectedDistricts.length === 0) {
            const allWards = [...new Set(data.mapping.map((d) => d.ward))];
            wardSelect.html(
              allWards.map((w) => `<option value="${w}">${w}</option>`)
            );
          } else {
            const filteredWards = selectedDistricts.flatMap(
              (d) => districtWardMap[d] || []
            );
            const uniqueWards = [...new Set(filteredWards)];
            wardSelect.html(
              uniqueWards.map((w) => `<option value="${w}">${w}</option>`)
            );
          }

          wardSelect.trigger("change");
          applyFilters();
        });

        wardSelect.on("change", applyFilters);
      }

      function renderOrders(orders) {
        const wrapper = document.getElementById("orders-wrapper");
        wrapper.innerHTML = "";
        const now = new Date();
        const table = document.createElement("table");
        table.className = "table table-bordered";
        table.innerHTML = `
        <thead>
          <tr>
            <th>Mã đơn</th><th>Địa chỉ</th><th>Khoảng cách quy định</th>
            <th>Khoảng cách thực</th><th>Thời gian di chuyển</th>
            <th>Ưu tiên</th><th>Thời gian tạo</th><th>Giao theo yêu cầu</th><th>Ghi chú</th>
          </tr>
        </thead><tbody></tbody>`;
        const tbody = table.querySelector("tbody");

        // Tạo danh sách thông báo cho đơn hàng quá hạn
        const notificationList = $("#notification-list");
        notificationList.empty(); // Xóa danh sách cũ

        const overdueOrders = orders.filter((o) => {
          const createdAt = new Date(o.address_created_at || o.created_at);
          const timeSinceCreated = (now - createdAt) / (1000 * 60); // Thời gian tính bằng phút
          return timeSinceCreated > 15; // Quá 15 phút
        });

        if (overdueOrders.length > 0) {
          overdueOrders.forEach((o) => {
            notificationList.append(
              `<li class="notification-blink">CẢNH BÁO: Đơn hàng ${o.id_order} đã quá 15 phút!</li>`
            );
          });
          $("#notification-container").fadeIn();
          setTimeout(() => {
            notificationList.empty();
            $("#notification-container").fadeOut();
          }, 30000); // Ẩn sau 30 giây
        }

        orders.forEach((o) => {
          const deadline = new Date(o.delivery_deadline);
          const timeToDeadline = (deadline - now) / (1000 * 60);
          let [priorityText, priorityClass] = [
            "Bình thường",
            "priority-normal",
          ];
          if (o.priority === 2)
            [priorityText, priorityClass] = ["Khẩn cấp", "priority-urgent"];
          else if (o.priority === 1)
            [priorityText, priorityClass] = ["Ưu tiên cao", "priority-high"];

          const row = document.createElement("tr");
          if (o.status === 1 && timeToDeadline <= 120)
            row.style.borderLeft = "6px solid red";

          [
            o.id_order,
            o.address,
            o.SOKM ?? "N/A",
            o.distance !== null ? o.distance.toFixed(2) : "N/A",
            o.travel_time,
            priorityText,
            formatDateTime(o.address_created_at || o.created_at),
            formatDateTime(o.delivery_deadline),
            o.delivery_note,
          ].forEach((txt) => {
            const td = document.createElement("td");
            td.textContent = txt;
            td.className = priorityClass;
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });
        wrapper.appendChild(table);
      }

      function formatDateTime(dateStr) {
        if (!dateStr) return "Không có";
        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? "Không có" : d.toLocaleString("vi-VN");
      }

      function renderPagination() {
        const container = document.getElementById("pagination");
        container.innerHTML = "";
        const prev = document.createElement("button");
        prev.textContent = "Trang trước";
        prev.disabled = currentPage === 1;
        prev.onclick = () => fetchOrders(currentDay, currentPage - 1);
        const next = document.createElement("button");
        next.textContent = "Trang sau";
        next.disabled = currentPage === totalPages;
        next.onclick = () => fetchOrders(currentDay, currentPage + 1);
        const info = document.createElement("span");
        info.textContent = ` Trang ${currentPage} / ${totalPages} `;
        container.appendChild(prev);
        container.appendChild(info);
        container.appendChild(next);
      }

      let searchTimeout;
      function debouncedSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(searchOrder, 300);
      }

      async function searchOrder() {
        const keyword = $("#searchInput").val().trim().toLowerCase();

        if (!keyword) {
          applyFilters();
          return;
        }

        try {
          const res = await fetch(`${apiUrl}?day=${currentDay}&all=true`);
          const data = await res.json();
          const filtered = (data.orders || []).filter((o) =>
            o.id_order.toLowerCase().includes(keyword)
          );

          renderOrders(filtered);
          $("#pagination").hide();
        } catch (err) {
          console.error("Lỗi tìm mã đơn hàng:", err.message);
          $("#error").text("Không tìm được đơn hàng theo mã.").show();
        }
      }

      async function applyFilters() {
        const selectedDistricts = $("#districtSelect").val();
        const selectedWards = $("#wardSelect").val();

        const hasDistricts = selectedDistricts && selectedDistricts.length > 0;
        const hasWards = selectedWards && selectedWards.length > 0;

        if (!hasDistricts && !hasWards) {
          $("#pagination").show();
          fetchOrders(currentDay, currentPage);
          return;
        }

        try {
          const query = new URLSearchParams({
            day: currentDay,
          });

          if (hasDistricts) {
            query.append("districts", selectedDistricts.join(","));
          }

          if (hasWards) {
            query.append("wards", selectedWards.join(","));
          }

          const res = await fetch(
            `/orders/filter-advanced?${query.toString()}`
          );
          const data = await res.json();

          renderOrders(data.orders || []);
          $("#pagination").hide();
        } catch (err) {
          console.error("Lỗi khi lọc đơn hàng nâng cao:", err.message);
          $("#error").text("Không thể lọc đơn hàng.").show();
        }
      }

      fetchOrders(currentDay, 1);
    </script>
  </body>
</html>
